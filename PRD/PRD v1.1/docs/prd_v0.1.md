# AgentComms MVP PRD（v0.1）

> 目标：第一阶段（MVP）让“我的两个 Agent”通过一套独立的系统服务实现**安全、可靠、低成本**的远程通讯。  
> 前提假设：每个“人类 Owner”都有一个 ETH Wallet（地址），具备签名能力。

---

## 1. 背景与问题

当 Agent 从单机/单账户扩展到跨团队、跨组织协作时，“沟通”会成为基础设施：
- Agent 需要能向其他 Agent **提出请求、交换信息、协商计划、反馈结果**
- 需要“可验证身份”“可控权限”“可追踪审计（至少是元数据级别）”
- 需要抗伪造、抗重放、抗垃圾消息，同时尽量低延迟、低运维成本

人类有 WeChat/Telegram：它们同时解决了**身份/通讯录/路由/存储/推送/安全**。  
Agent 也需要类似的“通信层 + 协议 + SDK”，但要更“机器可读”、更“可自动化治理”。

---

## 2. 产品愿景（1 句话）

**AgentComms = 面向 Agent 的安全通讯与协作网络：用钱包作为身份根，用端侧加密保证隐私，用可编程策略保证安全与成本。**

---

## 3. MVP 目标与非目标

### 3.1 MVP 目标（必须达成）
1. **两端 Agent 互相发送/接收消息**（至少 1:1）
2. **发送方身份可验证**（基于 Owner 钱包签名的 Agent 证书 + Agent 自身签名）
3. **消息内容端到端加密（E2EE）**：中继服务无法解密
4. **可靠传输**：至少一次投递（at-least-once），支持离线收取（store & forward）
5. **抗重放 + 基础风控**：时间窗、nonce、rate limit、allowlist
6. **开发者可用**：提供 SDK/CLI，让 Agent 按 spec 接入即可跑通

### 3.2 MVP 非目标（明确不做，避免膨胀）
- 去中心化/联邦化网络（先中心化中继，协议保持可迁移）
- 群聊/房间（第二阶段）
- 前向保密/群组 MLS（第二阶段）
- 链上存储消息（不做）
- 复杂支付结算（先留接口）

---

## 4. 典型用户与使用场景

### 4.1 Persona
- **Owner（人类）**：有 ETH 地址，拥有/管理自己的 Agent；希望安全对接同事/合作方
- **Agent（软件实体）**：运行在服务器或本地；代表 Owner 执行任务、对话
- **Relay/Directory（系统服务）**：消息中继 + 目录服务；默认不可信内容（看不到明文）

### 4.2 核心场景（MVP 只覆盖这些）
1. Owner A 注册 Agent A（生成密钥、Owner 签发证书、上传目录）
2. Owner B 注册 Agent B
3. A、B 双方把对方加入 allowlist（可人工配置）
4. Agent A → Agent B 发送加密消息
5. Agent B 收到后验证、解密、回复；双方完成 ACK

---

## 5. 功能需求（FRD）

### 5.1 账号/身份与注册
- FR-1：支持 Owner（ETH 地址）注册一个或多个 Agent
- FR-2：Owner 用钱包签名“Agent 证书”（绑定 Agent 公钥、权限、有效期）
- FR-3：目录服务可查询到 Agent 的公开信息（公钥、端点、证书）

### 5.2 通讯录/授权（allowlist）
- FR-4：Owner 可配置 allowlist：允许哪些对端 Owner/Agent 与我通信
- FR-5：Relay 在路由层做“最小策略”：不在 allowlist 的消息直接拒绝/隔离

### 5.3 消息收发
- FR-6：Agent 发送消息：签名 + 加密 + 上传 Relay
- FR-7：Agent 拉取/订阅消息：轮询或 SSE/WebSocket
- FR-8：支持 ACK：收件人确认已处理，Relay 可清理队列或标记状态
- FR-9：支持消息 TTL（过期自动清理）

### 5.4 运维与可观测
- FR-10：Relay 记录元数据日志（不含明文）：message_id、sender、recipient、size、timestamp、状态码
- FR-11：暴露基础指标：QPS、延迟、队列积压、失败率

---

## 6. 非功能需求（NFR）

- NFR-1：安全：E2EE，Relay 不可解密；所有消息可验证来源
- NFR-2：可靠：至少一次投递；客户端可幂等处理（去重）
- NFR-3：性能：MVP 目标 p95 端到端 < 2s（内网/同地域）
- NFR-4：成本：每条消息只做轻量验签 + 存储；不依赖链上写入
- NFR-5：可移植：协议版本化；可替换 Relay 实现

---

## 7. 成功指标（MVP）
- 首次接入时间：< 30 分钟（从生成密钥到两 Agent 互通）
- 可靠性：1000 条消息压测，丢失=0，重复<=1%（可通过去重消化）
- Relay 无法读取消息：数据库/日志只看到密文与元数据

---

## 8. 风险与对策（MVP 级）
- 风险：Agent 私钥泄露 → 对策：证书短有效期 + 轮换 + 可吊销
- 风险：垃圾消息/DoS → 对策：allowlist + rate limit + 配额
- 风险：元数据泄露（谁和谁说话）→ 对策：MVP 接受；后续引入混淆/去中心化路由
