openapi: 3.0.3
info:
  title: AgentComms API
  version: "0.1"
  description: |
    AgentComms MVP (ACP/0.1) Directory + Relay API.
    - Directory: register/query agent certificates (EIP-712 signed by Owner)
    - Relay: store & forward encrypted envelopes (E2EE), poll inbox, ack

    Notes:
    - Message payload is end-to-end encrypted. Server must NOT decrypt.
    - For request authentication (poll/ack and optionally send), use Agent request signature headers.
servers:
  - url: http://localhost:8080
tags:
  - name: Health
  - name: Directory
  - name: Relay

paths:
  /v1/healthz:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  version: { type: string }
                required: [ok, version]

  /v1/agents/register:
    post:
      tags: [Directory]
      summary: Register an Agent certificate (Owner-signed EIP-712)
      description: |
        Register or update an agent record by submitting an Owner-signed certificate.
        The server MUST verify the EIP-712 signature and store:
        - owner address
        - agent_id
        - agent signing public key (Ed25519)
        - agent encryption public key (Curve25519 for sealed box)
        - certificate metadata (expiry, nonce, permissions_hash, chain_id, signature)

        Auth:
        - MVP default: open registration with rate limits.
        - Optional: protect via admin token (implementation option).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterAgentRequest"
      responses:
        "200":
          description: Registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterAgentResponse"
        "400":
          description: Bad request / invalid schema
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Optional admin auth failed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "409":
          description: Conflict (e.g., agent_id already bound to another owner)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /v1/agents/{agent_id}:
    get:
      tags: [Directory]
      summary: Get agent record (certificate + public keys)
      parameters:
        - in: path
          name: agent_id
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Agent record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetAgentResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /v1/messages/send:
    post:
      tags: [Relay]
      summary: Send an encrypted envelope (store & forward)
      description: |
        Submit an ACP envelope. Server must:
        - parse header_b64, validate basic fields
        - look up sender agent, verify sender is active
        - verify message signature (Ed25519 over SHA256(header_bytes || ciphertext_bytes))
        - enforce allowlist and rate limits
        - enforce TTL and anti-replay (unique message_id per recipient)
        - store envelope and make it available to recipient via poll

        Auth:
        - Server MUST at least verify the message signature.
        - Optionally require request signature headers to reduce abuse.
      parameters:
        - $ref: "#/components/parameters/XAgentId"
        - $ref: "#/components/parameters/XTimestamp"
        - $ref: "#/components/parameters/XReqSignature"
        - $ref: "#/components/parameters/XBodySha256"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendMessageRequest"
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SendMessageResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "403":
          description: Not allowed by allowlist
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "409":
          description: Duplicate message_id (anti-replay)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /v1/messages/poll:
    get:
      tags: [Relay]
      summary: Poll inbox messages for an agent (at-least-once)
      description: |
        Fetch pending messages for recipient agent.
        - Messages are returned until ACKed.
        - Cursor is monotonic (e.g., messages table id).

        Auth:
        - MUST verify request signature headers (only the agent can poll its inbox).
      parameters:
        - $ref: "#/components/parameters/XAgentId"
        - $ref: "#/components/parameters/XTimestamp"
        - $ref: "#/components/parameters/XReqSignature"
        - $ref: "#/components/parameters/XBodySha256"
        - in: query
          name: agent_id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: cursor
          required: false
          schema: { type: string }
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
      responses:
        "200":
          description: Messages
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PollResponse" }
        "401":
          description: Request signature invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /v1/messages/ack:
    post:
      tags: [Relay]
      summary: ACK a message (idempotent)
      description: |
        ACK indicates the recipient has processed the message.
        Server should mark message as ACKed and stop returning it in poll.

        Auth:
        - MUST verify request signature headers (only the recipient can ACK).
      parameters:
        - $ref: "#/components/parameters/XAgentId"
        - $ref: "#/components/parameters/XTimestamp"
        - $ref: "#/components/parameters/XReqSignature"
        - $ref: "#/components/parameters/XBodySha256"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AckRequest" }
      responses:
        "200":
          description: ACKed
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AckResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Request signature invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

components:
  parameters:
    XAgentId:
      in: header
      name: X-Agent-Id
      required: false
      schema: { type: string, format: uuid }
      description: |
        Optional for send; required for poll/ack request authentication.
    XTimestamp:
      in: header
      name: X-Timestamp
      required: false
      schema: { type: integer, format: int64 }
      description: Unix epoch milliseconds. Used for request anti-replay.
    XReqSignature:
      in: header
      name: X-Req-Signature
      required: false
      schema: { type: string }
      description: |
        base64(Ed25519 signature) over SHA256(canonical_request_string).
        Required for poll/ack. Optional for send.
    XBodySha256:
      in: header
      name: X-Body-Sha256
      required: false
      schema: { type: string }
      description: |
        hex(SHA256(raw_request_body_bytes)).
        For GET requests, hash of empty string is acceptable.

  schemas:
    Error:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        details: { type: object, additionalProperties: true }
      required: [code, message]

    AgentCertificate:
      type: object
      properties:
        owner: { type: string, description: "ETH address (0x...)" }
        agent_id: { type: string, format: uuid }
        agent_sign_pk_b64: { type: string, description: "base64(32 bytes Ed25519 public key)" }
        agent_enc_pk_b64: { type: string, description: "base64(32 bytes Curve25519 public key)" }
        permissions_hash: { type: string, description: "0x-prefixed 32-byte hex (keccak256)" }
        issued_at_ms: { type: integer, format: int64 }
        expires_at_ms: { type: integer, format: int64 }
        nonce: { type: integer, format: int64 }
        chain_id: { type: integer, format: int64 }
        signature: { type: string, description: "0x-prefixed EIP-712 signature" }
      required:
        - owner
        - agent_id
        - agent_sign_pk_b64
        - agent_enc_pk_b64
        - permissions_hash
        - issued_at_ms
        - expires_at_ms
        - nonce
        - chain_id
        - signature

    RegisterAgentRequest:
      type: object
      properties:
        certificate:
          $ref: "#/components/schemas/AgentCertificate"
      required: [certificate]

    RegisterAgentResponse:
      type: object
      properties:
        ok: { type: boolean }
        agent:
          $ref: "#/components/schemas/AgentRecord"
      required: [ok, agent]

    AgentRecord:
      type: object
      properties:
        agent_id: { type: string, format: uuid }
        owner: { type: string }
        agent_sign_pk_b64: { type: string }
        agent_enc_pk_b64: { type: string }
        status: { type: string, enum: [active, revoked] }
        expires_at_ms: { type: integer, format: int64 }
      required: [agent_id, owner, agent_sign_pk_b64, agent_enc_pk_b64, status, expires_at_ms]

    GetAgentResponse:
      type: object
      properties:
        ok: { type: boolean }
        agent:
          $ref: "#/components/schemas/AgentCertificate"
      required: [ok, agent]

    Envelope:
      type: object
      properties:
        header_b64: { type: string, description: "base64url(UTF8(JSON header))" }
        ciphertext_b64: { type: string, description: "base64(ciphertext bytes)" }
        signature_b64: { type: string, description: "base64(Ed25519 signature over SHA256(header_bytes||ciphertext_bytes))" }
      required: [header_b64, ciphertext_b64, signature_b64]

    SendMessageRequest:
      type: object
      properties:
        envelope:
          $ref: "#/components/schemas/Envelope"
      required: [envelope]

    SendMessageResponse:
      type: object
      properties:
        ok: { type: boolean }
        message_id: { type: string, format: uuid }
        received_at_ms: { type: integer, format: int64 }
      required: [ok, message_id, received_at_ms]

    PollResponse:
      type: object
      properties:
        ok: { type: boolean }
        agent_id: { type: string, format: uuid }
        messages:
          type: array
          items: { $ref: "#/components/schemas/Envelope" }
        next_cursor: { type: string }
      required: [ok, agent_id, messages, next_cursor]

    AckRequest:
      type: object
      properties:
        agent_id: { type: string, format: uuid }
        message_id: { type: string, format: uuid }
      required: [agent_id, message_id]

    AckResponse:
      type: object
      properties:
        ok: { type: boolean }
        message_id: { type: string, format: uuid }
        acked_at_ms: { type: integer, format: int64 }
      required: [ok, message_id, acked_at_ms]
